{% extends 'index.html' %}

{% block content %}

<style>
    .bouncing-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        margin-top: 20px; /* Adjust this value to position the loader lower */
    }

    .bouncing-loader > div {
        width: 6px;  /* Smaller width */
        height: 6px;  /* Smaller height */
        margin: 3px;
        background: #808080;
        border-radius: 50%;
        animation: bouncing-loader 0.6s infinite alternate;
    }

    .bouncing-loader > div:nth-child(2) {
        animation-delay: 0.2s;
    }

    .bouncing-loader > div:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes bouncing-loader {
        to {
            opacity: 0.1;
            transform: translate3d(0, -16px, 0);
        }
    }

    /* Tailwind CSS classes for heading tags */
    .chat-content h1 {
        font-size: 2.25rem; /* text-4xl */
        font-weight: 700; /* font-bold */
    }
    .chat-content h2 {
        font-size: 1.875rem; /* text-3xl */
        font-weight: 600; /* font-semibold */
    }
    .chat-content h3 {
        font-size: 1.5rem; /* text-2xl */
        font-weight: 600; /* font-semibold */
    }
    .chat-content h4 {
        font-size: 1.25rem; /* text-xl */
        font-weight: 600; /* font-semibold */
    }
    .chat-content h5 {
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* font-semibold */
    }
    .chat-content h6 {
        font-size: 1rem; /* text-base */
        font-weight: 600; /* font-semibold */
    }
</style>

<title>Chatbot Tutor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>

<div class="flex flex-col h-screen bg-gray-100">
    <!-- Chat Container -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-2 flex flex-col">
        <!-- Messages dynamically added here -->
    </div>

    <!-- Input Section -->
    <div class="bg-white border-t p-4 flex items-center">
        <textarea id="user-input" placeholder="Type your message..."
            class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none"
            rows="1"></textarea>
        <button id="send-button" onclick="sendMessage()"
            class="ml-4 bg-blue-500 hover:bg-blue-600 text-white font-medium px-6 py-2 rounded-full transition">
            Send
        </button>
    </div>
</div>

<!-- Back Button -->
<button id="back-button" onclick="goBack()" class="inline-block bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition cursor-pointer mt-6 mb-6">Back to Course</button>

<script>
    var socket = io();
    
    var courseName = "{{ course.name }}";
    var learningStyle = "{{ student.learning_style }}";
    var learningPace = "{{ student.learning_pace }}";
    var vectorStoreId = "{{ course.vector_store_id }}";
    

    function sendMessage() {
        let inputField = document.getElementById("user-input");
        let sendButton = document.getElementById("send-button");

        let message = inputField.value.trim();
        if (message) {
            displayMessage(message, "user");

            // Disable input and send button while waiting for bot response
            inputField.disabled = true;
            sendButton.disabled = true;

            // Add loading animation
            let loadingDiv = document.createElement("div");
            loadingDiv.className = "flex justify-start";
            loadingDiv.id = "loading-animation";
            loadingDiv.innerHTML = `
                <div class="bouncing-loader">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>`;
            document.getElementById("chat-container").appendChild(loadingDiv);
            document.getElementById("chat-container").scrollTop = document.getElementById("chat-container").scrollHeight;

            // Send message to backend
            socket.emit("send_message", {
                message: message, 
                courseName: courseName, 
                learningStyle: learningStyle, 
                learningPace: learningPace, 
                vectorStoreId: vectorStoreId
            });

            inputField.value = "";
        }
    }

    function displayMessage(message, sender) {
        let chatContainer = document.getElementById("chat-container");
        let messageDiv = document.createElement("div");
        let messageBubble = document.createElement("div");

        // Base styles for chat bubbles
        messageBubble.className = "px-4 py-2 rounded-lg max-w-[50%] break-words whitespace-pre-wrap shadow-md text-left mb-2 chat-content";

        // Keep messages aligned to the left for both user and bot
        messageDiv.className = "flex justify-start"; 
        
        if (sender === "user") {
            messageBubble.className += " bg-blue-500 text-white"; // Blue bubble for user messages
        } else {
            messageBubble.className += " bg-gray-200 text-gray-800"; // Gray bubble for bot messages
        }

        // Replace \n with <br> for proper line breaks
        messageBubble.innerHTML = message.replace(/\n/g, '<br>');
        messageDiv.appendChild(messageBubble);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    socket.on("receive_message", function(data) {
        let loadingElement = document.getElementById("loading-animation");
        if (loadingElement) {
            loadingElement.remove(); // Remove loading animation
        }
        displayMessage(data.message, "bot");

        // Re-enable input and send button after receiving response
        document.getElementById("user-input").disabled = false;
        document.getElementById("send-button").disabled = false;

        // Focus input field for user convenience
        document.getElementById("user-input").focus();
    });

    // Listen for Enter key press in the input field
    document.getElementById("user-input").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            if (event.shiftKey) {
                // Insert a newline instead of sending the message
                event.preventDefault();
                let inputField = document.getElementById("user-input");
                let cursorPos = inputField.selectionStart;
                let textBefore = inputField.value.substring(0, cursorPos);
                let textAfter = inputField.value.substring(cursorPos);

                // Insert a newline at the cursor position
                inputField.value = textBefore + "\n" + textAfter;
                inputField.selectionStart = inputField.selectionEnd = cursorPos + 1;
            } else {
                // Send the message when Enter is pressed without Shift
                event.preventDefault();
                sendMessage();
            }
        }
    });

    function goBack() {
        window.history.back();
    }
</script>

{% endblock %}