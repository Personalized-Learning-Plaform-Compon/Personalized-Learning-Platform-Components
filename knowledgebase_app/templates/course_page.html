{% extends "index.html" %}

{% block content %}

<div class="max-w-4xl mx-auto mt-8 p-6 bg-white shadow-lg rounded-lg">
    <!-- Course Header -->
    <h1 class="text-3xl font-bold text-gray-800 text-center">{{ course.name }}</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <!-- Sidebar: Topics / Modules -->
        <div class="md:col-span-1 bg-gray-100 p-4 rounded-lg">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Topics</h3>
            <ul class="space-y-2">
                {% for folder in course.folders %}
                    <li>
                        <a href="{{ url_for('view_folder', folder_id=folder.id) }}" 
                           class="block py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                            {{ folder.name }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="md:col-span-2 space-y-6">
            <!-- Progress Indicator -->
            <div class="flex flex-col items-center">
                <div class="relative w-24 h-24">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="text-gray-300" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"></circle>
                        <circle class="text-blue-500" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"
                                stroke-dasharray="251.2" stroke-dashoffset="{{ 251.2 - (course.progress if course.progress else 0) * 2.512 }}"
                                stroke-linecap="round"></circle>
                    </svg>
                    <span class="absolute inset-0 flex items-center justify-center text-lg font-semibold text-gray-800">
                        {{ course.progress if course.progress else 0 }}%
                    </span>
                </div>
                <p class="text-gray-700 mt-2">Course Progress</p>
            </div>

            <!-- Course Overview -->
            <div class="bg-gray-100 p-4 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-700">Course Overview</h3>
                <p class="text-gray-600 mt-2">
                    Welcome to the course page for <span class="font-medium">"{{ course.name }}"</span>!
                </p>
            </div>

            <!-- Content Based on Learning Style -->
            {% if suggested_content %}
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold text-blue-700">Recommended for {{ student.learning_style }} Learners</h3>
                    <ul class="mt-3 space-y-2">
                        {% for content in suggested_content %}
                            <li>
                                <a href="{{ url_for('view_file', course_id=course.id, folder_name=content.folder.name, filename=content.filename, file_extension=content.file_extension) }}" 
                                   class="block py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                   target="_blank">
                                    {{ content.filename }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- Back to Dashboard Button -->
            <div class="text-center">
                <a href="{{ url_for('dashboard') }}" class="inline-block bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
<div class="recommendations-container mt-10">
    <h2 class="text-2xl font-semibold text-center mb-4">Personalized Content Recommendations</h2>
  
    <div class="recommendation-section bg-gray-100 p-4 rounded-lg mb-6">
      <h3 class="text-xl font-semibold">ðŸ“‰ Focus Areas for Improvement</h3>
      <ul id="weak-recommendations" class="quiz-list"></ul>
    </div>
  
    <div class="recommendation-section bg-gray-100 p-4 rounded-lg">
      <h3 class="text-xl font-semibold">ðŸš€ Advanced Challenges</h3>
      <ul id="strong-recommendations" class="quiz-list"></ul>
    </div>
  </div>
  
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    {% for course in courses %}
      fetch("/milestones/{{ current_user.id }}/{{ course.id }}")
        .then(response => response.json())
        .then(data => {
          document.getElementById("completed-quizzes-{{ course.id }}").innerText = data.completed_quizzes;
          document.getElementById("total-quizzes-{{ course.id }}").innerText = data.total_quizzes;
          document.getElementById("progress-percentage-{{ course.id }}").innerText = data.completion_percentage + "%";
          document.getElementById("progress-fill-{{ course.id }}").style.width = data.completion_percentage + "%";
          
        })
        .catch(error => console.error("Error fetching milestone data:", error));
    {% endfor %}


    {% for course, teacher in courses %}
    console.log("Fetching data from /milestones/{{ current_user.id }}/{{ course.id }}");
    fetch("/milestones/{{ current_user.id }}/{{ course.id }}")
      .then(response => response.json())
      .then(data => {
        document.getElementById("completed-quizzes-{{ course.id }}").innerText = data.completed_quizzes;
        document.getElementById("total-quizzes-{{ course.id }}").innerText = data.total_quizzes;
        document.getElementById("progress-percentage-{{ course.id }}").innerText = data.completion_percentage + "%";
        document.getElementById("progress-fill-{{ course.id }}").style.width = data.completion_percentage + "%";
    
  })
      .catch(error => console.error("Error fetching milestone data:", error));
    {% endfor %}


    fetch("/recommendations/{{ current_user.id }}")
      .then(response => response.json())
      .then(data => {
        updateRecommendations("weak-recommendations", data.weak_areas_quizzes);
        updateRecommendations("strong-recommendations", data.strong_areas_quizzes);
      })
      .catch(error => console.error("Error fetching recommendations:", error));
  
    function updateRecommendations(containerId, quizzes) {
      const list = document.getElementById(containerId);
      list.innerHTML = quizzes.length ? "" : "<li>No recommendations available.</li>";
  
      quizzes.forEach(quiz => {
        let item = document.createElement("li");
        item.innerHTML = `
          <div class="quiz-card">
            <p><strong>Topic:</strong> ${quiz.topic}</p>
            <p><strong>Quiz ID:</strong> ${quiz.quiz_id}</p>
            <span class="difficulty-tag ${quiz.difficulty.toLowerCase()}">${quiz.difficulty}</span>
            <button class="start-quiz" onclick="startQuiz(${quiz.quiz_id})">Start Quiz</button>
          </div>
        `;
        list.appendChild(item);
      });
    }
  });
  
  function startQuiz(quizId) {
    window.location.href = `/quiz/${quizId}`;
  }
  </script>
{% endblock %}
